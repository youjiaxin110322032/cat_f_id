<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Cat Face ID</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Noto Sans TC", sans-serif;
      background: #f5f5f5;
      color: #222;
    }
    nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: #222;
      color: #fff;
    }
    nav .left {
      font-weight: 700;
    }
    nav .right button {
      margin-left: 8px;
    }
    main {
      padding: 16px;
      max-width: 960px;
      margin: 0 auto;
    }
    #preview {
      width: 100%;
      max-width: 640px;
      background: #000;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    .video-wrapper {
      position: relative;
      display: inline-block;
    }
    #status {
      margin-top: 8px;
    }
    #chat-card {
      margin-top: 24px;
      padding: 16px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
      display: none;
    }
    #chat-box {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 8px;
      margin-bottom: 8px;
      background: #fafafa;
    }
    .msg {
      margin-bottom: 4px;
    }
    .msg .role {
      font-weight: 700;
      margin-right: 4px;
    }
    #chat-input {
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    /* modal / backdrop for login / register / cat card */
    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      min-width: 280px;
      max-width: 400px;
    }
    .modal h2 {
      margin-top: 0;
    }
    .modal .error {
      color: #c00;
      margin-top: 4px;
      font-size: 14px;
    }
    .hidden { display: none; }

    #cat-cursor {
      position: fixed;
      width: 32px;
      height: 32px;
      pointer-events: none;
      transform: translate(-50%, -50%);
      transition: transform 0.1s ease-out;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <!-- ä¸Šæ–¹å°è¦½åˆ— -->
  <nav>
    <div class="left">
      ğŸ± Cat Face ID
      <span style="font-size: 12px; margin-left: 8px;">API: <span id="api-url"></span></span>
    </div>
    <div class="right">
      <span id="userEmail"></span>
      <button id="navBtnLogin">ç™»å…¥</button>
      <button id="navBtnRegister">è¨»å†Š</button>
      <button id="navBtnLogout" style="display:none;">ç™»å‡º</button>
    </div>
  </nav>

  <main>
    <!-- ç›¸æ©Ÿå€ -->
    <section>
      <h2>è²“è‡‰è¾¨è­˜</h2>
      <p>å·²çŸ¥è²“å’ªï¼š<span id="knownCats">è¼‰å…¥ä¸­â€¦</span></p>

      <div class="video-wrapper">
        <video id="preview" autoplay playsinline></video>
        <canvas id="overlay"></canvas>
      </div>

      <div style="margin-top: 8px;">
        <button id="btnStart">é–‹å•Ÿç›¸æ©Ÿ</button>
        <button id="btnShot">æ‹ç…§è¾¨è­˜</button>
      </div>
      <div id="status">ç‹€æ…‹ï¼šå°šæœªå•Ÿå‹•</div>
    </section>

    <!-- èŠå¤©å®¤ -->
    <section id="chat-card">
      <h2>è²“å’ªèŠå¤©åŠ©æ‰‹</h2>
      <div id="chat-box"></div>
      <textarea id="chat-input" rows="3" placeholder="è¼¸å…¥è¨Šæ¯ï¼ŒæŒ‰ Enter é€å‡ºï¼ˆShift+Enter æ›è¡Œï¼‰"></textarea>
      <div>
        <button id="btn-send">é€å‡º</button>
        <button id="btn-logout">å¾é€™è£¡ç™»å‡º</button>
      </div>
    </section>
  </main>

  <!-- Login Modal -->
  <div id="loginModal" class="backdrop hidden">
    <div class="modal">
      <h2>ç™»å…¥</h2>
      <label>Emailï¼š<br><input id="loginEmail" type="email" /></label><br><br>
      <label>å¯†ç¢¼ï¼š<br><input id="loginPwd" type="password" /></label>
      <div id="loginError" class="error"></div>
      <div style="margin-top: 8px;">
        <button id="btnDoLogin">ç™»å…¥</button>
        <button id="btnCancelLogin">å–æ¶ˆ</button>
      </div>
      <div style="margin-top: 8px; font-size: 14px;">
        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ<button id="gotoRegister">è¨»å†Š</button>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="backdrop hidden">
    <div class="modal">
      <h2>è¨»å†Š</h2>
      <label>Emailï¼š<br><input id="regEmail" type="email" /></label><br><br>
      <label>å¯†ç¢¼ï¼š<br><input id="regPwd" type="password" /></label>
      <div id="regError" class="error"></div>
      <div style="margin-top: 8px;">
        <button id="btnDoRegister">è¨»å†Š</button>
      </div>
      <div style="margin-top: 8px; font-size: 14px;">
        å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ<button id="gotoLogin">æ”¹æˆç™»å…¥</button>
      </div>
    </div>
  </div>

  <!-- è²“çˆªæ¸¸æ¨™ï¼ˆçµ¦ JS ç”¨ï¼‰ -->
  <img id="cat-cursor" src="https://cat-f-id.onrender.com/static/more_img/cat_paw.png" alt="cursor" />

  <!-- ä¸‹é¢æ•´æ®µå°±æ˜¯ä½ å‰›è²¼çš„ scriptï¼ŒåŸå°ä¸å‹•æ”¾åœ¨ body æœ€å¾Œ -->
  <script type="module">
    // =========================
    // 1. Firebase åˆå§‹åŒ–
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcvsZn418xMLXL9KuM5FQaAmFhtsCvd8E",
      authDomain: "cat-f-id.firebaseapp.com",
      databaseURL: "https://cat-f-id-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cat-f-id",
      storageBucket: "cat-f-id.firebasestorage.app",
      messagingSenderId: "717846269620",
      appId: "1:717846269620:web:4b6d0ae716b7b60ae891e1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // æ–¹ä¾¿ debug
    window.debugGetToken = async () => {
      const user = auth.currentUser;
      if (!user) {
        console.log("å°šæœªç™»å…¥");
        return;
      }
      const t = await user.getIdToken(true);
      console.log("ID TOKEN =", t);
      return t;
    };

    // =========================
    // 2. å¾Œç«¯ API è¨­å®š
    // =========================
    const API_URL  = "https://catfaceid.onrender.com/predict";
    const API_BASE = API_URL.replace("/predict", "");   // => https://catfaceid.onrender.com

    const apiUrlEl = document.getElementById("api-url");
    if (apiUrlEl) {
      apiUrlEl.textContent = API_URL;
    }

    // =========================
    // 3. é é¢å…ƒç´ 
    // =========================
    const video     = document.getElementById("preview");
    const overlay   = document.getElementById("overlay");
    const ctx       = overlay ? overlay.getContext("2d") : null;

    const statusEl  = document.getElementById("status");
    const btnStart  = document.getElementById("btnStart");
    const btnShot   = document.getElementById("btnShot");
    const knownCats = document.getElementById("knownCats");

    // å°è¦½åˆ—ç™»å…¥/è¨»å†Š/ç™»å‡º
    const navBtnLogin    = document.getElementById("navBtnLogin");
    const navBtnLogout   = document.getElementById("navBtnLogout");
    const navBtnRegister = document.getElementById("navBtnRegister");
    const userEmailSpan  = document.getElementById("userEmail");

    // Login Modal
    const loginModal   = document.getElementById("loginModal");
    const loginEmail   = document.getElementById("loginEmail");
    const loginPwd     = document.getElementById("loginPwd");
    const btnDoLogin   = document.getElementById("btnDoLogin");
    const btnCancelLogin = document.getElementById("btnCancelLogin");
    const loginError   = document.getElementById("loginError");

    // Register Modal
    const registerModal = document.getElementById("registerModal");
    const regEmail      = document.getElementById("regEmail");
    const regPwd        = document.getElementById("regPwd");
    const btnDoRegister = document.getElementById("btnDoRegister");
    const regError      = document.getElementById("regError");
    const gotoRegister  = document.getElementById("gotoRegister");
    const gotoLogin     = document.getElementById("gotoLogin");

    // èŠå¤©å®¤
    const chatCard      = document.getElementById("chat-card");
    const chatBox       = document.getElementById("chat-box");
    const chatInput     = document.getElementById("chat-input");
    const btnSend       = document.getElementById("btn-send");
    const btnChatLogout = document.getElementById("btn-logout");

    // =========================
    // 4. å…±ç”¨å°å·¥å…·
    // =========================
    function setStatus(s) {
      if (!statusEl) return;
      statusEl.textContent = "ç‹€æ…‹ï¼š" + s;
    }

    function clearOverlay() {
      if (!ctx || !overlay) return;
      ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    function resizeOverlay() {
      if (!video || !overlay || !ctx) return;
      const rect = video.getBoundingClientRect();
      overlay.width  = rect.width * devicePixelRatio;
      overlay.height = rect.height * devicePixelRatio;
      overlay.style.width  = rect.width + "px";
      overlay.style.height = rect.height + "px";
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      clearOverlay();
    }
    window.addEventListener("resize", resizeOverlay);

    async function getFirebaseTokenOrThrow() {
      const user = auth.currentUser;
      if (!user) {
        throw new Error("å°šæœªç™»å…¥");
      }
      return await user.getIdToken();
    }

    // =========================
    // 5. Firebase ç™»å…¥/è¨»å†Š/ç™»å‡º
    // =========================
    if (navBtnLogin) {
      navBtnLogin.addEventListener("click", (e) => {
        e.preventDefault();
        if (!loginModal || !loginError) return;
        loginModal.classList.remove("hidden");
        loginError.textContent = "";
      });
    }

    if (navBtnRegister) {
      navBtnRegister.addEventListener("click", (e) => {
        e.preventDefault();
        if (!registerModal) return;
        registerModal.classList.remove("hidden");
        if (loginModal) loginModal.classList.add("hidden");
        if (regError) regError.textContent = "";
      });
    }

    if (btnCancelLogin && loginModal) {
      btnCancelLogin.addEventListener("click", () => {
        loginModal.classList.add("hidden");
      });
    }

    if (loginModal) {
      loginModal.addEventListener("click", (e) => {
        if (e.target === loginModal) loginModal.classList.add("hidden");
      });
    }

    if (registerModal) {
      registerModal.addEventListener("click", (e) => {
        if (e.target === registerModal) registerModal.classList.add("hidden");
      });
    }

    if (gotoRegister) {
      gotoRegister.addEventListener("click", () => {
        if (!loginModal || !registerModal) return;
        loginModal.classList.add("hidden");
        registerModal.classList.remove("hidden");
        if (regError) regError.textContent = "";
      });
    }

    if (gotoLogin) {
      gotoLogin.addEventListener("click", () => {
        if (!loginModal || !registerModal) return;
        registerModal.classList.add("hidden");
        loginModal.classList.remove("hidden");
        if (loginError) loginError.textContent = "";
      });
    }

    if (btnDoLogin) {
      btnDoLogin.addEventListener("click", async () => {
        try {
          await signInWithEmailAndPassword(auth, loginEmail.value, loginPwd.value);
          if (loginModal) loginModal.classList.add("hidden");
          loginEmail.value = "";
          loginPwd.value = "";
        } catch (e) {
          if (loginError) loginError.textContent = "ç™»å…¥å¤±æ•—ï¼š" + e.message;
        }
      });
    }

    if (btnDoRegister) {
      btnDoRegister.addEventListener("click", async () => {
        const email = regEmail.value;
        const password = regPwd.value;

        if (password.length < 6) {
          if (regError) regError.textContent = "å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 å€‹å­—å…ƒ";
          return;
        }
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          alert("è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥ã€‚");
          if (registerModal) registerModal.classList.add("hidden");
          regEmail.value = "";
          regPwd.value = "";
        } catch (e) {
          if (!regError) return;
          if (e.code === "auth/email-already-in-use") {
            regError.textContent = "æ­¤ Email å·²ç¶“è¢«è¨»å†Šéäº†";
          } else {
            regError.textContent = "è¨»å†Šå¤±æ•—ï¼š" + e.message;
          }
        }
      });
    }

    if (navBtnLogout) {
      navBtnLogout.addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        alert("å·²ç™»å‡º");
      });
    }

    if (btnChatLogout) {
      btnChatLogout.addEventListener("click", async () => {
        await signOut(auth);
        alert("å·²ç™»å‡º");
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!navBtnLogin || !navBtnRegister || !navBtnLogout || !userEmailSpan || !chatCard || !chatBox) {
        return;
      }

      if (user) {
        navBtnLogin.style.display    = "none";
        navBtnRegister.style.display = "none";
        navBtnLogout.style.display   = "inline";
        userEmailSpan.textContent    = user.email || "";
        chatCard.style.display       = "block";
        loadHistory();
      } else {
        navBtnLogin.style.display    = "inline";
        navBtnRegister.style.display = "inline";
        navBtnLogout.style.display   = "none";
        userEmailSpan.textContent    = "";
        chatCard.style.display       = "none";
        chatBox.innerHTML            = "";
      }
    });

    // =========================
    // 6. ç›¸æ©Ÿ & /predict
    // =========================
    let currentStream = null;
    let toJpegQuality = 0.9;

    async function startCamera() {
      try {
        const token = await getFirebaseTokenOrThrow();

        // é€šçŸ¥å¾Œç«¯ã€Œæœ‰äººé–‹ç›¸æ©Ÿã€
        try {
          const res = await fetch(`${API_BASE}/camera_open`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const me = await res.json();
            console.log("å¾Œç«¯èªè­‰çš„é–‹å•Ÿè€…ï¼š", me.email, me.uid);
          } else {
            console.warn("å‘¼å« /camera_open å¤±æ•—ï¼šHTTP", res.status);
          }
        } catch (e) {
          console.warn("å‘¼å« /camera_open ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
        }

        if (!video) {
          console.warn("æ‰¾ä¸åˆ° video#preview");
          return;
        }

        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        await video.play();
        currentStream = stream;
        resizeOverlay();
        setStatus("ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ");
      } catch (e) {
        console.error(e);
        setStatus("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—");
        alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š" + e.message);
      }
    }

    async function grabVideoFrameBlob() {
      if (!video || !video.videoWidth) return null;
      const tmp = document.createElement("canvas");
      tmp.width = video.videoWidth;
      tmp.height = video.videoHeight;
      tmp.getContext("2d").drawImage(video, 0, 0, tmp.width, tmp.height);
      return await new Promise(res => tmp.toBlob(res, "image/jpeg", toJpegQuality));
    }

    async function sendToAPI(imageBlob) {
      const token = await getFirebaseTokenOrThrow();
      const fd = new FormData();
      fd.append("file", imageBlob, "shot.jpg");

      const r = await fetch(API_URL, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd
      });
      if (r.status === 401) throw new Error("é©—è­‰å¤±æ•—ï¼šè«‹é‡æ–°ç™»å…¥");
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    // =========================
    // 7. è²“å’ªå¡ç‰‡ & ç•™è¨€
    // =========================
    const STATIC_BASE = "https://cat-f-id.onrender.com/static";
    const catImages = {
      mama: `${STATIC_BASE}/more_img/mama_headshot.png`,
      coco: `${STATIC_BASE}/more_img/coco_headshot.png`,
      jojo: `${STATIC_BASE}/more_img/jojo_headshot.png`
    };

    function createCatModal(catName, imgUrl = null) {
      const backdrop = document.createElement("div");
      backdrop.className = "backdrop";
      backdrop.dataset.cat = catName;
      backdrop.style.zIndex = 1000 + document.querySelectorAll(".backdrop").length;

      backdrop.innerHTML = `
        <div class="modal">
          <div style="text-align:right;">
            <button class="modalClose">é—œé–‰</button>
          </div>
          <div class="catresume">
            <img src="${imgUrl || catImages[catName] || `${STATIC_BASE}/more_img/unknown_cat.png`}" style="max-width:120px;">
            <div>
              <div class="modalNames">
                <span class="chip">${catName}</span>
              </div>
              <div class="comment-box">
                <input type="text" class="commentInput" placeholder="åŒ¿åç•™è¨€..." />
                <button class="commentBtn">ç™¼å¸ƒ</button>
              </div>
              <div class="comment-list"></div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(backdrop);

      const closeBtn    = backdrop.querySelector(".modalClose");
      const commentInput = backdrop.querySelector(".commentInput");
      const commentBtn   = backdrop.querySelector(".commentBtn");
      const commentList  = backdrop.querySelector(".comment-list");

      if (closeBtn) {
        closeBtn.addEventListener("click", () => backdrop.remove());
      }
      backdrop.addEventListener("click", e => { if (e.target === backdrop) backdrop.remove(); });

      function renderComments(comments) {
        if (!commentList) return;
        commentList.innerHTML = comments.map(c => {
          if (typeof c === "string") return `<div class="comment">${c}</div>`;
          return `<div class="comment"><strong>${c.author || "åŒ¿å"}:</strong> ${c.text}</div>`;
        }).join("");
      }

      async function loadComments() {
        try {
          const user = auth.currentUser;
          const headers = {};
          if (user) {
            const token = await user.getIdToken();
            headers["Authorization"] = `Bearer ${token}`;
          }
          const res = await fetch(`${API_BASE}/comments?cat_name=${encodeURIComponent(catName)}`, { headers });
          const data = await res.json();
          renderComments(data.comments || []);
        } catch {
          renderComments([]);
        }
      }

      if (commentBtn && commentInput) {
        commentBtn.addEventListener("click", async () => {
          const text = commentInput.value.trim();
          if (!text) return;

          try {
            const token = await getFirebaseTokenOrThrow();
            const res = await fetch(`${API_BASE}/comment?cat_name=${encodeURIComponent(catName)}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ text })
            });
            if (res.status === 401) {
              alert("é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥");
              return;
            }
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            renderComments(data.comments || []);
            commentInput.value = "";
          } catch (e) {
            alert("ç•™è¨€å¤±æ•—ï¼š" + e.message);
          }
        });
      }

      loadComments();
    }

    async function captureAndSend() {
      if (!video || !video.videoWidth) return;
      setStatus("æ“·å–ç•«é¢ä¸­â€¦");
      try {
        const blob = await grabVideoFrameBlob();
        if (!blob) return;
        setStatus("ä¸Šå‚³è¾¨è­˜ä¸­â€¦");
        const data = await sendToAPI(blob);

        const boxes = data.boxes || [];
        if (!boxes.length) {
          setStatus("æ²’æœ‰åµæ¸¬åˆ°è²“è‡‰");
          return;
        }
        for (let i = 0; i < boxes.length; i++) {
          const b = boxes[i];
          const catKey = b.name === "Unknown" ? `Unknown_${i + 1}` : b.name;
          createCatModal(catKey, b.imgUrl || null);
          await new Promise(res => setTimeout(res, 200));
        }
        setStatus("å®Œæˆ");
      } catch (e) {
        console.error(e);
        alert("è¾¨è­˜å¤±æ•—ï¼š" + e.message);
        setStatus("è¾¨è­˜å¤±æ•—");
      }
    }

    if (btnStart) btnStart.addEventListener("click", startCamera);
    if (btnShot)  btnShot.addEventListener("click", captureAndSend);

    // =========================
    // 8. èŠå¤©å®¤ï¼šç”¨ Firebase Token call /chat
    // =========================
    function appendMessage(role, text) {
      if (!chatBox) return;
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.innerHTML = `<span class="role">${role === "user" ? "æˆ‘" : "åŠ©ç†"}</span> ${text}`;
      chatBox.appendChild(div);
    }

    async function loadHistory() {
      if (!chatBox) return;
      try {
        const token = await getFirebaseTokenOrThrow();
        const res = await fetch(`${API_BASE}/history`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        chatBox.innerHTML = "";
        for (const m of data) {
          appendMessage(m.role, m.content);
        }
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.warn("è¼‰å…¥æ­·å²å¤±æ•—ï¼š", e);
      }
    }

    async function sendMessage() {
      if (!chatInput || !btnSend) return;
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";
      appendMessage("user", text);
      btnSend.disabled = true;

      try {
        const token = await getFirebaseTokenOrThrow();
        const res = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ message: text })
        });
        btnSend.disabled = false;

        if (!res.ok) {
          appendMessage("assistant", "ï¼ˆå¾Œç«¯éŒ¯èª¤ï¼š" + res.status + "ï¼‰");
          return;
        }

        const data = await res.json();
        appendMessage("assistant", data.reply);
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        btnSend.disabled = false;
        appendMessage("assistant", "ï¼ˆé€å‡ºå¤±æ•—ï¼š" + e.message + "ï¼‰");
      }
    }

    if (btnSend) {
      btnSend.addEventListener("click", sendMessage);
    }
    if (chatInput) {
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // =========================
    // 9. è²“çˆªæ¸¸æ¨™ & å·²çŸ¥è²“åˆ—è¡¨
    // =========================
    const catCursor = document.getElementById("cat-cursor");
    if (catCursor) {
      document.addEventListener("mousemove", e => {
        catCursor.style.left = `${e.clientX}px`;
        catCursor.style.top  = `${e.clientY}px`;
      });
      document.addEventListener("click", () => {
        catCursor.style.transform = "scale(0.8)";
        setTimeout(() => catCursor.style.transform = "scale(1)", 100);
      });
    }

    (async () => {
      if (!knownCats) return;
      try {
        const labelsURL = API_URL.replace("/predict", "/labels");
        const r = await fetch(labelsURL);
        const j = await r.json();
        knownCats.textContent = (j.labels || []).join("ã€") || "ï¼ˆç„¡ï¼‰";
      } catch {
        knownCats.textContent = "ç„¡æ³•å–å¾—";
      }
    })();
  </script>
</body>
</html>
