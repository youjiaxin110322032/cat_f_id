<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Cat Face ID</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- âœ… ç”¨ä½ é‚£ä»½ CSS -->
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <!-- ä¸Šæ–¹å›ºå®š Headerï¼Œé…åˆ CSS -->
  <header>
    <div>
      <h1>çŒ´ç¡è²“æ‘è§€å…‰æŒ‡å— | è²“è‡‰è¾¨è­˜ç³»çµ±</h1>
      <p class="api">APIï¼š<span id="api-url"></span></p>
      <p class="known">å·²çŸ¥è²“å’ªï¼š<span id="knownCats">è¼‰å…¥ä¸­â€¦</span></p>
    </div>
    <nav>
      <p id="userEmail"></p>
      <button id="navBtnLogin">ç™»å…¥</button>
      <button id="navBtnRegister">è¨»å†Š</button>
      <button id="navBtnLogout" style="display:none;">ç™»å‡º</button>
    </nav>
  </header>

  <!-- å…§æ–‡åŒ…åœ¨ .wrap è£¡ï¼Œè®“ padding / å®½åº¦ç”Ÿæ•ˆ -->
  <div class="wrap">
    <!-- ç›¸æ©Ÿå€ -->
    <section>
      <h1>è²“è‡‰è¾¨è­˜</h1>

      <div class="cam-box">
        <video id="preview" autoplay playsinline></video>
        <canvas id="overlay" class="overlay"></canvas>
      </div>

      <div class="btns">
        <button id="btnStart">é–‹å•Ÿç›¸æ©Ÿ</button>
        <button id="btnShot">æ‹ç…§è¾¨è­˜</button>
      </div>

      <div class="panel">
        <div class="row">
          <span class="tag">ç‹€æ…‹</span>
          <span id="status" class="small">å°šæœªå•Ÿå‹•</span>
        </div>
      </div>
    </section>


    <button id="chat-launcher" style="display: none;">
      ğŸ±
    </button>

    <section id="chat-card" class="chat-window" style="display: none;">
      <div class="chat-header">
        <div class="title">
            <span>AIè²“å’ªæ‘é•·</span>
            <span id="chat-status" style="font-size:0.8em; color:#bfbfbf;">(ç·šä¸Š)</span>
        </div>
        <button id="btn-close-chat" class="close-btn">Ã—</button>
      </div>

      <div id="chat-box"></div>

      <div class="chat-footer">
        <textarea id="chat-input" rows="1" placeholder="è¼¸å…¥è¨Šæ¯..."></textarea>
        <div class="chat-actions">
            <button id="btn-logout" class="btn-small secondary">ç™»å‡º</button>
            <button id="btn-send" class="btn-small primary">é€å‡º</button>
        </div>
      </div>
    </section>


  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="backdrop hidden">
    <div class="modal">
      <img id="modalCloseLogin" src="/static/more_img/close.png" alt="close" />
      <h1>ç™»å…¥</h1>
      <p>Email</p>
      <input id="loginEmail" type="email" />
      <p style="margin-top:12px;">å¯†ç¢¼</p>
      <input id="loginPwd" type="password" />
      <div id="loginError" class="error" style="margin-top:8px; color:#c00; font-size:14px;"></div>
      <button id="btnDoLogin" class="secondary" style="margin-top:16px;">ç™»å…¥</button>
      <p style="margin-top:12px; font-size:14px;">
        é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ
        <button id="gotoRegister" class="secondary" style="flex:0 0 auto; padding:6px 12px;">è¨»å†Š</button>
      </p>
    </div>
  </div>

  <!-- Register Modal -->
  <div id="registerModal" class="backdrop hidden">
    <div class="modal">
      <img id="modalCloseRegister" src="/static/more_img/close.png" alt="close" />
      <h1>è¨»å†Š</h1>
      <p>Email</p>
      <input id="regEmail" type="email" />
      <p style="margin-top:12px;">å¯†ç¢¼</p>
      <input id="regPwd" type="password" />
      <div id="regError" class="error" style="margin-top:8px; color:#c00; font-size:14px;"></div>
      <button id="btnDoRegister" class="secondary" style="margin-top:16px;">è¨»å†Š</button>
      <p style="margin-top:12px; font-size:14px;">
        å·²ç¶“æœ‰å¸³è™Ÿï¼Ÿ
        <button id="gotoLogin" class="secondary" style="flex:0 0 auto; padding:6px 12px;">æ”¹æˆç™»å…¥</button>
      </p>
    </div>
  </div>

  <!-- è²“çˆªæ¸¸æ¨™ -->
  <img id="cat-cursor" src="/static/more_img/cat_hand.png" alt="cursor" />

  <script type="module">
    // =========================
    // 1. Firebase åˆå§‹åŒ–
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDcvsZn418xMLXL9KuM5FQaAmFhtsCvd8E",
      authDomain: "cat-f-id.firebaseapp.com",
      databaseURL: "https://cat-f-id-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "cat-f-id",
      storageBucket: "cat-f-id.firebasestorage.app",
      messagingSenderId: "717846269620",
      appId: "1:717846269620:web:4b6d0ae716b7b60ae891e1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    window.debugGetToken = async () => {
      const user = auth.currentUser;
      if (!user) {
        console.log("å°šæœªç™»å…¥");
        return;
      }
      const t = await user.getIdToken(true);
      console.log("ID TOKEN =", t);
      return t;
    };

    // =========================
    // 2. å¾Œç«¯ API è¨­å®š
    // =========================
    const API_URL  = "/predict";
    const API_BASE = API_URL.replace("/predict", "");

    const apiUrlEl   = document.getElementById("api-url");
    if (apiUrlEl) apiUrlEl.textContent = API_URL;

    // =========================
    // 3. é é¢å…ƒç´ 
    // =========================
    const video     = document.getElementById("preview");
    const overlay   = document.getElementById("overlay");
    const ctx       = overlay ? overlay.getContext("2d") : null;

    const statusEl  = document.getElementById("status");
    const btnStart  = document.getElementById("btnStart");
    const btnShot   = document.getElementById("btnShot");
    const knownCats = document.getElementById("knownCats");

    const navBtnLogin    = document.getElementById("navBtnLogin");
    const navBtnLogout   = document.getElementById("navBtnLogout");
    const navBtnRegister = document.getElementById("navBtnRegister");
    const userEmailSpan  = document.getElementById("userEmail");

    const loginModal       = document.getElementById("loginModal");
    const loginEmail       = document.getElementById("loginEmail");
    const loginPwd         = document.getElementById("loginPwd");
    const btnDoLogin       = document.getElementById("btnDoLogin");
    const btnCancelLogin   = document.getElementById("btnCancelLogin");
    const loginError       = document.getElementById("loginError");
    const modalCloseLogin  = document.getElementById("modalCloseLogin");

    const registerModal      = document.getElementById("registerModal");
    const regEmail           = document.getElementById("regEmail");
    const regPwd             = document.getElementById("regPwd");
    const btnDoRegister      = document.getElementById("btnDoRegister");
    const regError           = document.getElementById("regError");
    const gotoRegister       = document.getElementById("gotoRegister");
    const gotoLogin          = document.getElementById("gotoLogin");
    const modalCloseRegister = document.getElementById("modalCloseRegister");

    const chatCard      = document.getElementById("chat-card");
    const chatBox       = document.getElementById("chat-box");
    const chatInput     = document.getElementById("chat-input");
    const btnSend       = document.getElementById("btn-send");
    const btnChatLogout = document.getElementById("btn-logout");
    const launcherBtn   = document.getElementById("chat-launcher");
    const closeChatBtn  = document.getElementById("btn-close-chat");

    // =========================
    // 4. å…±ç”¨å°å·¥å…·
    // =========================
    function setStatus(s) {
      if (!statusEl) return;
      statusEl.textContent = s;
    }

    function clearOverlay() {
      if (!ctx || !overlay) return;
      ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    function resizeOverlay() {
      if (!video || !overlay || !ctx) return;
      const rect = video.getBoundingClientRect();
      overlay.width  = rect.width * devicePixelRatio;
      overlay.height = rect.height * devicePixelRatio;
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      clearOverlay();
    }
    window.addEventListener("resize", resizeOverlay);

    async function getFirebaseTokenOrThrow() {
      const user = auth.currentUser;
      if (!user) throw new Error("å°šæœªç™»å…¥");
      return await user.getIdToken();
    }

    // =========================
    // 5. Firebase ç™»å…¥/è¨»å†Š/ç™»å‡ºï¼ˆæœ‰é…åˆ .backdrop CSSï¼‰
    // =========================
    function openBackdrop(el) {
      if (!el) return;
      el.classList.remove("hidden");
      el.style.display = "flex";     // è®“å®ƒè“‹é .backdrop { display:none }
    }
    function closeBackdrop(el) {
      if (!el) return;
      el.classList.add("hidden");
      el.style.display = "none";
    }

    if (navBtnLogin) {
      navBtnLogin.addEventListener("click", (e) => {
        e.preventDefault();
        if (!loginModal) return;
        if (loginError) loginError.textContent = "";
        openBackdrop(loginModal); 
      });
    }

    if (navBtnRegister) {
      navBtnRegister.addEventListener("click", (e) => {
        e.preventDefault();
        if (!registerModal) return;
        if (regError) regError.textContent = "";
        openBackdrop(registerModal);
      });
    }

    if (btnCancelLogin && loginModal) {
      btnCancelLogin.addEventListener("click", () => {
        closeBackdrop(loginModal);
      });
    }

    if (modalCloseLogin && loginModal) {
      modalCloseLogin.addEventListener("click", () => closeBackdrop(loginModal));
    }
    if (modalCloseRegister && registerModal) {
      modalCloseRegister.addEventListener("click", () => closeBackdrop(registerModal));
    }

    if (loginModal) {
      loginModal.addEventListener("click", (e) => {
        if (e.target === loginModal) closeBackdrop(loginModal);
      });
    }
    if (registerModal) {
      registerModal.addEventListener("click", (e) => {
        if (e.target === registerModal) closeBackdrop(registerModal);
      });
    }

    if (gotoRegister) {
      gotoRegister.addEventListener("click", () => {
        closeBackdrop(loginModal);
        openBackdrop(registerModal);
        if (regError) regError.textContent = "";
      });
    }

    if (gotoLogin) {
      gotoLogin.addEventListener("click", () => {
        closeBackdrop(registerModal);
        openBackdrop(loginModal);
        if (loginError) loginError.textContent = "";
      });
    }

    if (btnDoLogin) {
      btnDoLogin.addEventListener("click", async () => {
        try {
          await signInWithEmailAndPassword(auth, loginEmail.value, loginPwd.value);
          closeBackdrop(loginModal);
          loginEmail.value = "";
          loginPwd.value = "";
        } catch (e) {
          if (loginError) loginError.textContent = "ç™»å…¥å¤±æ•—ï¼š" + e.message;
        }
      });
    }

    if (btnDoRegister) {
      btnDoRegister.addEventListener("click", async () => {
        const email = regEmail.value;
        const password = regPwd.value;
        if (password.length < 6) {
          if (regError) regError.textContent = "å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 å€‹å­—å…ƒ";
          return;
        }
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          alert("è¨»å†ŠæˆåŠŸï¼å·²è‡ªå‹•ç™»å…¥ã€‚");
          closeBackdrop(registerModal);
          regEmail.value = "";
          regPwd.value = "";
        } catch (e) {
          if (!regError) return;
          if (e.code === "auth/email-already-in-use") {
            regError.textContent = "æ­¤ Email å·²ç¶“è¢«è¨»å†Šéäº†";
          } else {
            regError.textContent = "è¨»å†Šå¤±æ•—ï¼š" + e.message;
          }
        }
      });
    }

    if (navBtnLogout) {
      navBtnLogout.addEventListener("click", async (e) => {
        e.preventDefault();
        await signOut(auth);
        alert("å·²ç™»å‡º");
      });
    }
    if (btnChatLogout) {
      btnChatLogout.addEventListener("click", async () => {
        await signOut(auth);
        alert("å·²ç™»å‡º");
      });
    }

    onAuthStateChanged(auth, (user) => {
      if (!navBtnLogin || !navBtnRegister || !navBtnLogout || !userEmailSpan || !chatCard || !chatBox || !launcherBtn) return;
      if (user) {
        navBtnLogin.style.display    = "none";
        navBtnRegister.style.display = "none";
        navBtnLogout.style.display   = "inline-block";
        userEmailSpan.textContent    = user.email || "";
        
        launcherBtn.style.display = "flex"; 
        launcherBtn.style.opacity = "1";         // ç¢ºä¿æŒ‰éˆ•å¯è¦‹
        launcherBtn.style.pointerEvents = "auto"; // ç¢ºä¿å¯é»æ“Š
        
        chatCard.style.display = "none";         // é è¨­é—œé–‰è¦–çª—
        chatCard.classList.remove("open");       // ç¢ºä¿æ²’æœ‰é–‹å•Ÿçš„å‹•ç•« class

        loadHistory();
      } else {
        navBtnLogin.style.display    = "inline-block";
        navBtnRegister.style.display = "inline-block";
        navBtnLogout.style.display   = "none";
        userEmailSpan.textContent    = "";
        // å…¨éƒ¨éš±è—
        chatCard.style.display       = "none";
        chatCard.classList.remove("open");
        launcherBtn.style.display    = "none"; // éš±è—å•Ÿå‹•æŒ‰éˆ•

        chatBox.innerHTML            = "";
      }
    });

    // =========================
    // 6. ç›¸æ©Ÿ & /predict
    // =========================
    let currentStream = null;
    let toJpegQuality = 0.9;

    async function startCamera() {
      try {
        const token = await getFirebaseTokenOrThrow();

        try {
          const res = await fetch(`${API_BASE}/camera_open`, {
            method: "POST",
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const me = await res.json();
            console.log("å¾Œç«¯èªè­‰çš„é–‹å•Ÿè€…ï¼š", me.email, me.uid);
          } else {
            console.warn("å‘¼å« /camera_open å¤±æ•—ï¼šHTTP", res.status);
          }
        } catch (e) {
          console.warn("å‘¼å« /camera_open ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
        }

        if (!video) {
          console.warn("æ‰¾ä¸åˆ° video#preview");
          return;
        }

        if (currentStream) currentStream.getTracks().forEach(t => t.stop());
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;
        await video.play();
        currentStream = stream;
        resizeOverlay();
        setStatus("ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ");
      } catch (e) {
        console.error(e);
        setStatus("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—");
        alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š" + e.message);
      }
    }

    async function grabVideoFrameBlob() {
      if (!video || !video.videoWidth) return null;
      const tmp = document.createElement("canvas");
      tmp.width = video.videoWidth;
      tmp.height = video.videoHeight;
      tmp.getContext("2d").drawImage(video, 0, 0, tmp.width, tmp.height);
      return await new Promise(res => tmp.toBlob(res, "image/jpeg", toJpegQuality));
    }

    async function sendToAPI(imageBlob) {
      const token = await getFirebaseTokenOrThrow();
      const fd = new FormData();
      fd.append("file", imageBlob, "shot.jpg");

      const r = await fetch(API_URL, {
        method: "POST",
        headers: { Authorization: `Bearer ${token}` },
        body: fd
      });
      if (r.status === 401) throw new Error("é©—è­‰å¤±æ•—ï¼šè«‹é‡æ–°ç™»å…¥");
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return await r.json();
    }

    // =========================
    // 7. è²“å’ªå¡ç‰‡ & ç•™è¨€
    // =========================
    const STATIC_BASE = "https://cat-f-id.onrender.com/static";
    const catImages = {
      mama: `${STATIC_BASE}/more_img/mama_headshot.png`,
      coco: `${STATIC_BASE}/more_img/coco_headshot.png`,
      jojo: `${STATIC_BASE}/more_img/jojo_headshot.png`
    };

    function createCatModal(catName, imgUrl = null) {
      const backdrop = document.createElement("div");
      backdrop.className = "backdrop";
      backdrop.style.display = "flex";

      backdrop.innerHTML = `
        <div class="modal">
          <img id="modalClose" src="${STATIC_BASE}/more_img/close.png" alt="close" />
          <div class="catresume">
            <img src="${imgUrl || catImages[catName] || `${STATIC_BASE}/more_img/unknown_cat.png`}" class="img01">
            <div>
              <div class="modalNames">
                <span class="chip">${catName}</span>
              </div>
              <div class="comment-box">
                <input type="text" class="commentInput" placeholder="åŒ¿åç•™è¨€..." />
                <button class="botton02 commentBtn">ç™¼å¸ƒ</button>
              </div>
              <div class="comment-list"></div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(backdrop);

      const closeBtn    = backdrop.querySelector("#modalClose");
      const commentInput = backdrop.querySelector(".commentInput");
      const commentBtn   = backdrop.querySelector(".commentBtn");
      const commentList  = backdrop.querySelector(".comment-list");

      if (closeBtn) {
        closeBtn.addEventListener("click", () => backdrop.remove());
      }
      backdrop.addEventListener("click", e => { if (e.target === backdrop) backdrop.remove(); });

      function renderComments(comments) {
        if (!commentList) return;
        commentList.innerHTML = comments.map(c => {
          if (typeof c === "string") {
            return `<div class="comment-ms"><p>${c}</p></div>`;
          }
          return `<div class="comment-ms">
                    <p><strong>${c.author || "åŒ¿å"}</strong></p>
                    <p>${c.text}</p>
                  </div>`;
        }).join("");
      }

      async function loadComments() {
        try {
          const user = auth.currentUser;
          const headers = {};
          if (user) {
            const token = await user.getIdToken();
            headers["Authorization"] = `Bearer ${token}`;
          }
          const res = await fetch(`${API_BASE}/comments?cat_name=${encodeURIComponent(catName)}`, { headers });
          const data = await res.json();
          renderComments(data.comments || []);
        } catch {
          renderComments([]);
        }
      }

      if (commentBtn && commentInput) {
        commentBtn.addEventListener("click", async () => {
          const text = commentInput.value.trim();
          if (!text) return;
          try {
            const token = await getFirebaseTokenOrThrow();
            const res = await fetch(`${API_BASE}/comment?cat_name=${encodeURIComponent(catName)}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
              },
              body: JSON.stringify({ text })
            });
            if (res.status === 401) {
              alert("é©—è­‰å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥");
              return;
            }
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            renderComments(data.comments || []);
            commentInput.value = "";
          } catch (e) {
            alert("ç•™è¨€å¤±æ•—ï¼š" + e.message);
          }
        });
      }

      loadComments();
    }

    async function captureAndSend() {
      if (!video || !video.videoWidth) return;
      setStatus("æ“·å–ç•«é¢ä¸­â€¦");
      try {
        const blob = await grabVideoFrameBlob();
        if (!blob) return;
        setStatus("ä¸Šå‚³è¾¨è­˜ä¸­â€¦");
        const data = await sendToAPI(blob);

        const boxes = data.boxes || [];
        if (!boxes.length) {
          setStatus("æ²’æœ‰åµæ¸¬åˆ°è²“è‡‰");
          return;
        }
        for (let i = 0; i < boxes.length; i++) {
          const b = boxes[i];
          const catKey = b.name === "Unknown" ? `Unknown_${i + 1}` : b.name;
          createCatModal(catKey, b.imgUrl || null);
          await new Promise(res => setTimeout(res, 200));
        }
        setStatus("å®Œæˆ");
      } catch (e) {
        console.error(e);
        alert("è¾¨è­˜å¤±æ•—ï¼š" + e.message);
        setStatus("è¾¨è­˜å¤±æ•—");
      }
    }

    if (btnStart) btnStart.addEventListener("click", startCamera);
    if (btnShot)  btnShot.addEventListener("click", captureAndSend);

    // =========================
    // 8. èŠå¤©å®¤
    // =========================
    function appendMessage(role, text) {
      if (!chatBox) return;
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.innerHTML = `<span class="role">${role === "user" ? "æˆ‘" : "åŠ©ç†"}</span> ${text}`;
      chatBox.appendChild(div);
    }

    async function loadHistory() {
      if (!chatBox) return;
      try {
        const token = await getFirebaseTokenOrThrow();
        const res = await fetch(`${API_BASE}/history`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!res.ok) return;
        const data = await res.json();
        chatBox.innerHTML = "";
        for (const m of data) appendMessage(m.role, m.content);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        console.warn("è¼‰å…¥æ­·å²å¤±æ•—ï¼š", e);
      }
    }

    async function sendMessage() {
      if (!chatInput || !btnSend) return;
      const text = chatInput.value.trim();
      if (!text) return;
      chatInput.value = "";
      appendMessage("user", text);
      btnSend.disabled = true;
      try {
        const token = await getFirebaseTokenOrThrow();
        const res = await fetch(`${API_BASE}/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ message: text })
        });
        btnSend.disabled = false;
        if (!res.ok) {
          appendMessage("assistant", "ï¼ˆå¾Œç«¯éŒ¯èª¤ï¼š" + res.status + "ï¼‰");
          return;
        }
        const data = await res.json();
        appendMessage("assistant", data.reply);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (e) {
        btnSend.disabled = false;
        appendMessage("assistant", "ï¼ˆé€å‡ºå¤±æ•—ï¼š" + e.message + "ï¼‰");
      }
    }

    if (btnSend) btnSend.addEventListener("click", sendMessage);
    if (chatInput) {
      chatInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // =========================
    // 9. è²“çˆªæ¸¸æ¨™ & å·²çŸ¥è²“åˆ—è¡¨
    // =========================
    const catCursor = document.getElementById("cat-cursor");
    if (catCursor) {
      document.addEventListener("mousemove", e => {
        catCursor.style.left = `${e.clientX}px`;
        catCursor.style.top  = `${e.clientY}px`;
      });
      document.addEventListener("click", () => {
        catCursor.style.transform = "scale(0.9)";
        setTimeout(() => catCursor.style.transform = "scale(1)", 100);
      });
    }

    (async () => {
      if (!knownCats) return;
      try {
        const labelsURL = API_URL.replace("/predict", "/labels");
        const r = await fetch(labelsURL);
        const j = await r.json();
        knownCats.textContent = (j.labels || []).join("ã€") || "ï¼ˆç„¡ï¼‰";
      } catch {
        knownCats.textContent = "ç„¡æ³•å–å¾—";
      }
    })();

    // =========================
    // 10. èŠå¤©å®¤é–‹é—œå‹•ç•«é‚è¼¯ (æ–°å¢)
    // =========================
    
    // ğŸŸ¢ é»æ“Šåœ“å½¢æŒ‰éˆ• -> æ‰“é–‹èŠå¤©å®¤
    if (launcherBtn) {
        launcherBtn.addEventListener('click', () => {
            // 1. å…ˆè¨­å®š display: flex è®“å…ƒç´ å‡ºç¾åœ¨ DOM ä¸Š
            chatCard.style.display = 'flex';
            
            // 2. ç¨å¾®å»¶é²åŠ å…¥ classï¼Œè§¸ç™¼ CSS transition å‹•ç•«
            setTimeout(() => {
                chatCard.classList.add('open');
            }, 10);
            
            // 3. éš±è—åœ“å½¢æŒ‰éˆ• (è®Šæˆé€æ˜ä¸¦ä¸å¯é»æ“Šï¼Œé¿å…æ“‹è·¯)
            launcherBtn.style.opacity = '0';
            launcherBtn.style.pointerEvents = 'none';
        });
    }

    // ğŸ”´ é»æ“Š X æŒ‰éˆ• -> é—œé–‰èŠå¤©å®¤
    if (closeChatBtn) {
        closeChatBtn.addEventListener('click', () => {
            // 1. ç§»é™¤å‹•ç•« classï¼Œè¦–çª—æœƒç¸®ä¸‹å»
            chatCard.classList.remove('open');
            
            // 2. æ¢å¾©åœ“å½¢æŒ‰éˆ•
            launcherBtn.style.opacity = '1';
            launcherBtn.style.pointerEvents = 'auto';

            // 3. ç­‰ CSS å‹•ç•«è·‘å®Œ (0.3s) å†çœŸçš„æŠŠè¦–çª— display: none
            setTimeout(() => {
                chatCard.style.display = 'none';
            }, 300);
        });
    }
  </script>
</body>
</html>
