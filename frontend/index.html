<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Cat Face ID â€” Multi Cat</title>

  <!-- âœ… æ”¹æˆå¾ /static/ è¼‰å…¥ -->
  <link rel="stylesheet" href="/static/normalize.css">
  <link rel="stylesheet" href="/static/style.css">

  <style>
  .backdrop {
    display: flex;
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center; align-items: center;
    z-index: 10000;
  }

  .modal {
    background: #e6dfba;
    border-radius: 8px;
    padding: 20px;
    width: 450px;
    max-width: 90%;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    position: relative;
    font-family: 'Microsoft JhengHei', sans-serif;
    color: #5f4f00;
  }

  .modalClose {
    position: absolute;
    top: 12px; right: 12px;
    cursor: pointer;
    width: 24px;
    filter: invert(30%) sepia(70%) saturate(300%) hue-rotate(20deg) brightness(0.8);
  }

  .catresume {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
  }

  .catresume img {
    width: 120px;
    height: 140px;
    border-radius: 6px;
    object-fit: cover;
    border: 2px solid #7a6c00;
  }

  .catresume div {
    flex: 1;
  }

  .modalNames {
    background: #b0a653;
    border-radius: 4px;
    font-weight: 700;
    font-size: 24px;
    text-align: center;
    padding: 6px 0;
    margin-bottom: 8px;
    color: #3f3a00;
    user-select: none;
  }

  .catresume p {
    font-size: 14px;
    line-height: 1.4;
    white-space: pre-line;
  }

  .comment-box {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    justify-content: center;
  }

  .comment-box input[type="text"] {
    flex-grow: 1;
    padding: 8px 12px;
    border-radius: 16px;
    border: 1px solid #b0a653;
    font-size: 14px;
    outline: none;
  }

  .comment-box button {
    background: #7a6c00;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 16px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.3s ease;
  }

  .comment-box button:hover {
    background: #a3982f;
  }

  .comment-list {
    margin-top: 15px;
    max-height: 160px;
    overflow-y: auto;
    font-size: 14px;
    border-top: 1px solid #b0a653;
    padding-top: 10px;
  }

  .comment {
    padding: 4px 6px;
    border-bottom: 1px solid #d4cc87;
  }
  </style>
</head>

<body>
  <header>
    <h1>å–µå–µæ ªå¼æœƒç¤¾</h1>
    <nav>
      <!-- âœ… æ”¹æˆ /static/... -->
      <p><a href="/static/aboutus.html">é—œæ–¼æˆ‘å€‘</a></p>
      <p><a href="/static/index.html">å“¡å·¥è¾¨è­˜</a></p>
      <p><a href="/static/aboutsystem.html">ç³»çµ±ä»‹ç´¹</a></p>
      <p><a href="#" id="navBtnLogin">ç™»å…¥</a></p>
      <p><a href="#" id="navBtnLogout" style="display:none;">ç™»å‡º (<span id="userEmail"></span>)</a></p>
    </nav>
  </header>

  <div class="wrap">
    <h1>å“¡å·¥è¾¨è­˜</h1>
    <div class="cam-box">
      <video id="preview" playsinline autoplay muted></video>
      <canvas id="overlay" class="overlay"></canvas>
    </div>

    <div class="btns">
      <button id="btnStart" type="button">å•Ÿå‹•ç›¸æ©Ÿ</button>
      <button id="btnShot" type="button">é€²è¡Œè¾¨è­˜</button>
    </div>

    <div class="foot">
      <div class="msg" id="status">ç‹€æ…‹ï¼šå¾…æ©Ÿ</div>
      <div class="api hidden">APIï¼š<span id="api-url" class="small"></span></div>
      <div class="known hidden">å·²çŸ¥è²“ï¼š<span id="knownCats" class="small">è¼‰å…¥ä¸­â€¦</span></div>
    </div>
  </div>

  <div id="loginModal" class="backdrop" style="display: none;">
    <div class="modal" style="width: 300px; text-align: center;">
      <div class="modalNames">ç®¡ç†å“¡ç™»å…¥</div>
      <div style="padding: 20px;">
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
        <input type="password" id="loginPwd" placeholder="å¯†ç¢¼" style="width: 100%; padding: 8px; margin-bottom: 20px; box-sizing: border-box;">
        
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button id="btnDoLogin" style="background: #7a6c00; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer;">ç™»å…¥</button>
          <button id="btnCancelLogin" style="background: #ccc; color: #333; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
        </div>
        <p id="loginError" style="color: red; font-size: 12px; margin-top: 10px;"></p>
      </div>
    </div>
  </div>

  <!-- âœ… æ”¹æˆ /static/... -->
  <img id="cat-cursor" src="/static/more_img/cat_hand.png" alt="cat paw">

  <script type="module">

  // ğŸ‘‡ 1. å¼•å…¥ Firebase SDK (ä½¿ç”¨ CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // ğŸ‘‡ 2. è²¼ä¸Šä½ çš„ Firebase è¨­å®š (å¾ Firebase Console -> Project Settings -> General -> ä¸‹æ»‘åˆ° Your apps è¤‡è£½)
  const firebaseConfig = {
    apiKey: "AIzaSyDcvsZn418xMLXL9KuM5FQaAmFhtsCvd8E",
    authDomain: "cat-f-id.firebaseapp.com",
    databaseURL: "https://cat-f-id-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "cat-f-id",
    storageBucket: "cat-f-id.firebasestorage.app",
    messagingSenderId: "717846269620",
    appId: "1:717846269620:web:4b6d0ae716b7b60ae891e1"
  };

  // åˆå§‹åŒ– Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  // ğŸ‘† Firebase åˆå§‹åŒ–çµæŸ

  const API_URL = 'http://127.0.0.1:8000/predict';
  document.getElementById('api-url').textContent = API_URL;

  const video = document.getElementById('preview');
  const overlay = document.getElementById('overlay');
  const ctx = overlay.getContext('2d');
  const statusEl = document.getElementById('status');
  const btnStart = document.getElementById('btnStart');
  const btnShot  = document.getElementById('btnShot');
  const knownCats = document.getElementById('knownCats');

  // ==========================================
  // ğŸ‘‡ æ–°å¢ï¼šFirebase ç™»å…¥/ç™»å‡º é‚è¼¯
  // ==========================================
  const navBtnLogin = document.getElementById('navBtnLogin');
  const navBtnLogout = document.getElementById('navBtnLogout');
  const userEmailSpan = document.getElementById('userEmail');
  
  const loginModal = document.getElementById('loginModal');
  const loginEmail = document.getElementById('loginEmail');
  const loginPwd = document.getElementById('loginPwd');
  const btnDoLogin = document.getElementById('btnDoLogin');
  const btnCancelLogin = document.getElementById('btnCancelLogin');
  const loginError = document.getElementById('loginError');

  // ç›£è½ç™»å…¥ç‹€æ…‹æ”¹è®Š
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // å·²ç™»å…¥
      navBtnLogin.style.display = 'none';
      navBtnLogout.style.display = 'inline';
      userEmailSpan.textContent = user.email;
      console.log("User logged in:", user.email);
    } else {
      // æœªç™»å…¥
      navBtnLogin.style.display = 'inline';
      navBtnLogout.style.display = 'none';
      userEmailSpan.textContent = '';
      console.log("User logged out");
    }
  });
  
  // é–‹å•Ÿç™»å…¥è¦–çª—
  navBtnLogin.addEventListener('click', (e) => {
    e.preventDefault();
    loginModal.style.display = 'flex';
    loginError.textContent = '';
  });

  // é—œé–‰ç™»å…¥è¦–çª—
  btnCancelLogin.addEventListener('click', () => {
    loginModal.style.display = 'none';
  });

  // åŸ·è¡Œç™»å…¥
  btnDoLogin.addEventListener('click', async () => {
    const email = loginEmail.value;
    const password = loginPwd.value;
    
    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginModal.style.display = 'none'; // ç™»å…¥æˆåŠŸé—œé–‰è¦–çª—
      // æ¸…ç©ºè¼¸å…¥æ¡†
      loginEmail.value = '';
      loginPwd.value = '';
    } catch (error) {
      loginError.textContent = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
    }
  });

  // åŸ·è¡Œç™»å‡º
  navBtnLogout.addEventListener('click', (e) => {
    e.preventDefault();
    signOut(auth).then(() => {
      alert('å·²ç™»å‡º');
    });
  });

  // ==========================================
  // åŸæœ‰çš„åˆå§‹åŒ–åŸ·è¡Œ (IIFE)
  // ==========================================

  let currentStream = null;
  let toJpegQuality = 0.9;

  function setStatus(s){ statusEl.textContent = 'ç‹€æ…‹ï¼š' + s; }
  function clearOverlay(){ ctx.clearRect(0,0,overlay.width,overlay.height); }

  function resizeOverlay() {
    const rect = video.getBoundingClientRect();
    overlay.width = rect.width * devicePixelRatio;
    overlay.height = rect.height * devicePixelRatio;
    overlay.style.width = rect.width + 'px';
    overlay.style.height = rect.height + 'px';
    ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    clearOverlay();
  }
  window.addEventListener('resize', resizeOverlay);

  async function startCamera() {
    try {
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      video.srcObject = stream;
      await video.play();
      currentStream = stream;
      resizeOverlay();
      setStatus('ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸ');
    } catch(e) {
      console.error(e);
      setStatus('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—');
      alert('ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—');
    }
  }

  async function grabVideoFrameBlob() {
    if (!video.videoWidth) return null;
    const tmp = document.createElement('canvas');
    tmp.width = video.videoWidth; tmp.height = video.videoHeight;
    tmp.getContext('2d').drawImage(video, 0, 0, tmp.width, tmp.height);
    return await new Promise(res => tmp.toBlob(res, 'image/jpeg', toJpegQuality));
  }

  async function sendToAPI(imageBlob){
    const fd = new FormData();
    fd.append('file', imageBlob, 'shot.jpg');
    const r = await fetch(API_URL, { method: 'POST', body: fd });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return await r.json();
  }

  const catImages = {
    mama: '/static/more_img/mama_headshot.png',
    coco: '/static/more_img/coco_headshot.png',
    jojo: '/static/more_img/jojo_headshot.png'
  };

  function createCatModal(catName, imgUrl = null) {
    const backdrop = document.createElement('div');
    backdrop.className = 'backdrop';
    backdrop.dataset.cat = catName;
    backdrop.style.zIndex = 1000 + document.querySelectorAll('.backdrop').length;

    backdrop.innerHTML = `
      <div class="modal">
        <img class="modalClose" src="/static/more_img/close.png" alt="é—œé–‰">
        <div class="catresume">
          <img src="${imgUrl || catImages[catName] || '/static/more_img/unknown_cat.png'}">
          <div>
            <div class="modalNames">
              <span class="chip">${catName}</span>
            </div>
            <div class="comment-box">
              <input type="text" class="commentInput" placeholder="åŒ¿åç•™è¨€..." />
              <button class="commentBtn">ç™¼å¸ƒ</button>
            </div>
            <div class="comment-list"></div>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(backdrop);
    const closeBtn = backdrop.querySelector('.modalClose');
    closeBtn.addEventListener('click', () => backdrop.remove());
    backdrop.addEventListener('click', e => { if (e.target === backdrop) backdrop.remove(); });

      // ğŸ‘‡ æ–°å¢ï¼šå–å¾—ç•¶å‰ç™»å…¥çš„ä½¿ç”¨è€…
    const user = auth.currentUser; 
    // å¦‚æœæœ‰ç™»å…¥å°±ç”¨ Emailï¼Œæ²’ç™»å…¥å°±é¡¯ç¤º "åŒ¿å"
    const username = user ? user.email.split('@')[0] : "åŒ¿åè·¯äºº"; 

    // ğŸ‘‡ æŠŠåå­—çµ„åˆæˆç•™è¨€å…§å®¹ (æˆ–æ˜¯å¾Œç«¯ API æ”¯æ´ username æ¬„ä½çš„è©±æ›´å¥½ï¼Œé€™é‚Šç¤ºç¯„ç›´æ¥ä½µå…¥æ–‡å­—)
    const finalComment = `[${username}]: ${text}`;

    const commentInput = backdrop.querySelector('.commentInput');
    const commentBtn = backdrop.querySelector('.commentBtn');
    const commentList = backdrop.querySelector('.comment-list');

    async function loadComments() {
      try {
        const res = await fetch(`${API_URL.replace('/predict','/comments')}?cat_name=${catName}`);
        const data = await res.json();
        renderComments(data.comments || []);
      } catch {
        renderComments([]);
      }
    }

    function renderComments(comments) {
      commentList.innerHTML = comments.map(c => `<div class="comment">${c}</div>`).join('');
    }

    commentBtn.addEventListener('click', async () => {
      const text = commentInput.value.trim();
      if (!text) return;

      // åœ¨é€™è£¡å–å¾—ç•¶ä¸‹çš„ä½¿ç”¨è€…
      const user = auth.currentUser; 
      // å¦‚æœæœ‰ç™»å…¥å°±ç”¨ Emailï¼Œæ²’ç™»å…¥å°±é¡¯ç¤º "åŒ¿å"
      const username = user ? user.email.split('@')[0] : "åŒ¿åè·¯äºº"; 

      // çµ„åˆç•™è¨€å…§å®¹
      const finalComment = `[${username}]: ${text}`;

      try {
        const res = await fetch(`${API_URL.replace('/predict','/comment')}?cat_name=${catName}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: finalComment }) // å‚³é€çµ„åˆå¾Œçš„æ–‡å­—
        });
        const data = await res.json();
        renderComments(data.comments);
        commentInput.value = '';
      } catch (e) {
        alert('ç•™è¨€å¤±æ•—ï¼š' + e.message);
      }
    });

    loadComments();
  }

  async function captureAndSend() {
    if (!video.videoWidth) return;
    setStatus('æ“·å–ç•«é¢ä¸­â€¦');
    try {
      const blob = await grabVideoFrameBlob();
      if (!blob) return;
      setStatus('ä¸Šå‚³è¾¨è­˜ä¸­â€¦');
      const data = await sendToAPI(blob);

      const boxes = data.boxes || [];
      if (!boxes.length) {
        setStatus('æ²’æœ‰åµæ¸¬åˆ°è²“è‡‰');
        return;
      }

      for (let i = 0; i < boxes.length; i++) {
        const b = boxes[i];
        const catKey = b.name === 'Unknown' ? `Unknown_${i+1}` : b.name;
        createCatModal(catKey, b.imgUrl || null);
        await new Promise(res => setTimeout(res, 200));
      }
      setStatus('å®Œæˆ');
    } catch(e) {
      console.error(e);
      alert('è¾¨è­˜å¤±æ•—ï¼š' + e.message);
      setStatus('è¾¨è­˜å¤±æ•—');
    }
  }

  btnStart.addEventListener('click', startCamera);
  btnShot.addEventListener('click', captureAndSend);

  const catCursor = document.getElementById('cat-cursor');
  document.addEventListener('mousemove', e => {
    catCursor.style.left = `${e.clientX}px`;
    catCursor.style.top = `${e.clientY}px`;
  });
  document.addEventListener('click', e => {
    catCursor.style.transform = 'scale(0.8)';
    setTimeout(()=>catCursor.style.transform='scale(1)',100);
  });

  (async () => {
    try {
      const labelsURL = API_URL.replace('/predict','/labels');
      const r = await fetch(labelsURL);
      const j = await r.json();
      knownCats.textContent = (j.labels || []).join('ã€') || 'ï¼ˆç„¡ï¼‰';
    } catch {
      knownCats.textContent = 'ç„¡æ³•å–å¾—';
    }
  })();
  </script>

</body>
</html>
